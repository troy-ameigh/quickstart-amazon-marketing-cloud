== About the deployed microservices

This solution deploys three microservices, which you can access from the platform manager in the deployed Amazon SageMaker instance.

* Platform Management Service (PMS)
* Tenant Provisioning Service (TPS)										
* Workflow Management Service (WFM)

The PMS microservice uses the platform management library to interact with the other two microservices: Tenant Provisioning Service and Workflow Management Service. 

The TPS microservice is an Amazon Ad Tech solution that adds functionality for managing multiple AMC customers. It provides a centralized location to manage customers, supporting multitenancy and an ability to onboard customers without the need for custom solutions. Customers are mapped one-to-one with AMC instances. When a customer is onboarded, if an Amazon Simple Storage Service (Amazon S3) bucket doesn't already exist for the associated AMC instance, one is deployed.
												
With the WFM microservice, you can do the following:

* Synchronize workflows and their schedules in the Workflow Library service with multiple AMC instances.

* Send workflow requests to an Amazon Simple Queue Service (Amazon SQS) queue rather than directly to the AMC endpoint to prevent timeout failures when there are many requests in a short time.

* Schedule with dynamic, relative time windows rather than using AMC's scheduling feature, which allows only predefined scheduled reporting, such as daily or weekly. 

* Track the status of all workflow runs for customer AMC instances, whether they're submitted through WFM or other means, such as Postman. You can also track historical runs for troubleshooting or performance monitoring.

== Hydrate your data lake

Hydrate the data lake by populating it with data from your AMC instance. When you're finished, business stakeholders can use Amazon Athena to access the data returned by the workflow run.

. Sign in to the AWS Management Console, and open the Amazon SageMaker console.

. In the navigation pane, under *Notebook*, choose *Notebook Instances*. 

. Choose *Open JupyterLab* next to the deployed instance named `aws-quickstart-platform-manager-notebooks`. (The prefix, `aws-`, may differ depending on the value set in `ddk.json`.) This notebook instance opens in a new tab.

. Open `-Getting_Started-.ipynb`, and walk through using the TPS and WFM microservices.

NOTE: If your AMC S3 bucket contained data before deployment of this solution, the data lake does not pick up that data automatically. You must run workflows after deployment to start this process. 

== Query your data with Athena
If this is your first time using Athena on this AWS account, set the query result location in Amazon S3 as follows:

. Open the Athena console.
. From the sidebar, choose *Query editor*
. From the top menu, choose *Settings*.
. Choose *Manage*.
. Choose *Browse S3* next to the first open field.
. Choose the deployed S3 bucket with the suffix `-athena`. 
+
This bucket name follows the same convention as the others deployed. You can designate any custom bucket for this purpose; this bucket was deployed as part of the solution for convenience.

. Save the setting.

You are now ready to query your tables with Athena.

== Build a QuickSight dashboard
This section walks through how to build an Amazon QuickSight dashboard with AMC data from your data lake. For more information on using QuickSight features, refer to https://docs.aws.amazon.com/quicksight/latest/user/welcome.html[What is Amazon QuickSight?^]

=== Create a QuickSight account
To build your first dashboard, you must create a QuickSight account. If you do not have a QuickSight account already, create one by following these steps:

. From the AWS Management Console, search for and choose QuickSight.
. On the QuickSight page, choose *Sign up for QuickSight*.
. Keeping the default Enterprise edition, scroll down and choose *Continue*.
. Enter a QuickSight account name and a notification email address.
. Scroll down and choose *Finish*. The QuickSight console opens.

=== Authorize QuickSight to access AWS services
For QuickSight to access Athena, Amazon S3, and AWS Lake Formation, a QuickSight administrator must configure the AWS resource permissions. These permissions apply to all QuickSight users. If you're a QuickSight administrator (in which case you see the *Manage QuickSight* option when you open the menu from your profile at the upper right), you can authorize QuickSight access to AWS services by doing the following two procedures.

==== Authorize QuickSight to access Athena and Amazon S3
. In the QuickSight console, choose your profile name (upper right) and choose *Manage QuickSight*.
. Navigate to *Security & Permissions*.
. Under *QuickSight access to AWS services*, choose *Manage*.
. Find *Athena* in the list. Clear the box by Athena, and then select it again to enable Athena. Then choose *Next*.
. Under *S3 Bucket*, choose the S3 buckets to which you want to grant QuickSight read access. 
. From the right column, *Write permissions for Athena Workgroup*, choose the S3 buckets to which you want to grant QuickSight query-result write access. 
. Choose *Finish*, and save your settings.

==== Authorize QuickSight to access Lake Formation database and tables
. Find the Amazon Resource Names (ARNs) of the QuickSight users and groups that need access to Lake Formation data. Collect these ARNs, ensuring that the users are QuickSight authors or administrators. 
* To construct ARNs manually, use this string, replacing the bracketed items:
+
`arn:aws:quicksight:<REGION_NAME>:<ACCOUNT_ID>:user/default/<QUICKSIGHT_USERNAME>`
* To collect ARNS programmatically, run the following command in your terminal (Linux or macOS) or at your command prompt (Windows): 
+
`aws quicksight list-users --aws-account-id 111122223333 --namespace default --region us-east-1`

. Open the Lake Formation console as the data-lake administrator.
. Choose *Databases*, and select the database to which you want to grant your QuickSight user access. Then, for *Actions*, choose *Grant*.
. Select *SAML users and groups*, and enter the QuickSight user ARN.
. Choose *Named data catalog resources*.
. For *Tables*, select *All tables*, or select individual tables to which you want to grant your user access. Then for *Table permissions*, choose *Select* and *Describe*. Then choose *Grant*.
. Repeat the preceding steps to grant permissions to other users or groups. 

=== Create a dataset in QuickSight

After QuickSight has been authorized to access AWS services, you can create custom datasets in QuickSight using Athena as follows:

. In the QuickSight console, in the navigation pane, choose *Datasets*, and then choose *New dataset*.
. Create an Athena connection profile.
.. Under *FROM NEW DATA SOURCES*, choose the *Athena* data source card.
.. For *Data source name*, enter a descriptive name.
.. For *Athena Workgroup*, choose your workgroup.
.. Choose *Validate connection* to test the connection.
.. Choose *Create data source*.

. Choose your table.
.. On the *Choose your table* screen, under *Catalog*, choose *AwsDataCatalog*.
.. Do one of the following:
* Select the database and table manually from the dropdown.
* Choose *Use custom SQL* to pull data in with a Structured Query Language (SQL) query.
.. Choose *Select* or *Confirm Query*, depending on the option chosen earlier.
.. Choose *Visualize*.

Now you can create, publish, and share your custom dashboard.

== Delete deployed resources
When you no longer need the architecture that was deployed by this solution, delete the resources from your AWS account so that you're no longer charged for them. These resources include S3 buckets, AWS CloudFormation stacks, DataOps Development Kit (DDK) bootstrap, AWS CodeCommit repos, AWS Key Management Service (AWS KMS) keys, AWS Lambda layers, and SQS queues and rules. 

To delete all these resources, follow these steps:

. Look into `Makefile`.
+
```
$ cd quickstart-amazon-marketing-cloud
$ cat MakeFile
```

. Verify that the following functions are passing the correct stack names. Replace the information in brackets.

* The `delete_repositories` function is passing `-d <AMC_REPO_NAME>` (default: `ddk-amc-quickstart`).
+
* The `delete_bootstrap` function is passing `--stack-name <BOOTSTRAP_STACK_NAME>` (default: `DdkDevBootstrap`).

. Enter the following command:
+
```
$ make delete_all
```

Some CloudWatch general log groups may remain in your account with logs specific to this solution's resources. Examples:

* `/aws/sagemaker/NotebookInstances`
* `/aws-glue/jobs/error`
* `/aws-glue/jobs/output`